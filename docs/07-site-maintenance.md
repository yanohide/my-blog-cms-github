# サイトメンテナンスガイド

ブログサイトを安全に長く運用するためのメンテナンス手順です。月に 1 回程度、時間のあるときに確認してください。

---

## 目次

1. [メンテナンスの全体像](#1-メンテナンスの全体像)
2. [パッケージの更新](#2-パッケージの更新)
3. [バックアップの確認](#3-バックアップの確認)
4. [セキュリティの確認](#4-セキュリティの確認)
5. [Sanity プロジェクトの管理](#5-sanity-プロジェクトの管理)
6. [サイトのパフォーマンス確認](#6-サイトのパフォーマンス確認)
7. [年次チェックリスト](#7-年次チェックリスト)

---

## 1. メンテナンスの全体像

```
┌────────────────────────────────────────────────────────┐
│                    月次メンテナンス                       │
│                                                        │
│  □ パッケージの更新確認          （15〜30分）             │
│  □ バックアップの確認             （5分）                 │
│  □ セキュリティ項目の確認         （5分）                 │
│  □ Sanity の使用量確認           （5分）                 │
│  □ サイト表示速度の確認           （5分）                 │
└────────────────────────────────────────────────────────┘
```

> **ポイント**: すべてを毎月やる必要はありません。最低限「パッケージの更新」と「バックアップの確認」ができていれば安心です。

---

## 2. パッケージの更新

### パッケージとは？

このブログサイトは、多くの「パッケージ」（他の人が作ったプログラムの部品）を組み合わせて動いています。これらのパッケージは定期的にバージョンアップ（更新）され、バグの修正やセキュリティの改善が行われます。

### 更新の確認方法

ターミナルで以下のコマンドを実行します。

```bash
npm outdated
```

> **`npm outdated` とは？**
> 現在使っているパッケージのバージョンと、利用可能な最新バージョンを一覧で表示するコマンドです。

表示例：

```
Package    Current  Wanted  Latest
next       16.1.6   16.1.8  16.2.0
sanity     5.8.1    5.8.3   5.9.0
```

| 列 | 意味 |
|----|------|
| **Current** | 今使っているバージョン |
| **Wanted** | 現在の設定で安全に更新できるバージョン |
| **Latest** | 最新バージョン（大きな変更が含まれる可能性あり） |

### 安全な更新方法

**Step 1: Wanted バージョンに更新する（安全）**

```bash
npm update
```

> **`npm update` とは？**
> `package.json` の設定範囲内で安全に更新できるバージョンに自動更新するコマンドです。通常はこれだけで十分です。

**Step 2: ビルドが成功するか確認する**

```bash
npm run build
```

エラーが出なければ更新成功です。

**Step 3: GitHub にプッシュする**

```bash
git add package.json package-lock.json
git commit -m "パッケージを更新"
git push
```

> **重要**: `package.json` と `package-lock.json` の両方をプッシュしてください。`package-lock.json` はパッケージの正確なバージョン情報を記録するファイルです。

### メジャーバージョンの更新（上級者向け）

`Latest` の列が `Current` と大きく異なる場合（例：`16.x` → `17.x`）は「メジャーバージョンアップ」です。大きな変更が含まれるため、慎重に対応する必要があります。

> **メジャーバージョンとは？**
> バージョン番号の一番左の数字（例：`16.1.6` の `16`）です。この数字が変わると、使い方が変わる可能性があります。
>
> **おすすめ**: メジャーバージョンの更新は、AI ツール（Cursor や Claude Code）に「Next.js を 17 にアップグレードして」のように依頼すると安心です。

---

## 3. バックアップの確認

### このプロジェクトのバックアップ体制

| データ | 保存場所 | バックアップ方法 |
|--------|---------|---------------|
| コード（プログラム） | GitHub | `git push` で自動バックアップ |
| 記事の原稿 | `blog/` フォルダ → GitHub | `git push` で自動バックアップ |
| 記事の公開データ | Sanity | Sanity が自動バックアップ |
| 環境変数 | `.env.local`（ローカル）/ Vercel | 手動で管理 |

### 確認手順

**GitHub のバックアップ確認**

1. [https://github.com](https://github.com) にログインします
2. リポジトリを開きます
3. 最新のコミット日時が最近になっているか確認します
4. `blog/` フォルダに記事のマークダウンファイルが揃っているか確認します

**環境変数のバックアップ**

`.env.local` の内容は GitHub にアップロードされない（`.gitignore` で除外されている）ため、手動で管理する必要があります。

安全な保管方法：
- パスワード管理アプリ（1Password、Bitwarden など）に保存する
- メモ帳に書いてパソコンの安全な場所に保存する

> **重要**: `.env.local` の内容をメールやチャットで送らないでください。トークン（合言葉）が含まれています。

### Sanity のデータエクスポート（上級者向け）

Sanity CLI を使うと、記事データを手元にダウンロードできます。

```bash
npx sanity dataset export production ./backup/sanity-backup.tar.gz
```

> **このコマンドは何をしている？**
> Sanity の `production` データセットに保存されている全データを、圧縮ファイルとしてダウンロードします。万が一のデータ消失に備えたバックアップです。

---

## 4. セキュリティの確認

### 月次チェック項目

| 確認項目 | 確認方法 |
|---------|---------|
| `.env.local` が GitHub に公開されていないか | GitHub のリポジトリにファイルが表示されていないことを確認 |
| Sanity API トークンが漏洩していないか | 身に覚えのない記事が投稿されていないか確認 |
| GitHub の Personal Access Token の有効期限 | GitHub Settings → Developer settings で確認 |
| npm パッケージの脆弱性 | `npm audit` コマンドで確認 |

### npm パッケージの脆弱性チェック

```bash
npm audit
```

> **`npm audit` とは？**
> 使っているパッケージにセキュリティ上の問題（脆弱性）がないかチェックするコマンドです。

結果の読み方：

| 深刻度 | 英語表記 | 対応 |
|--------|---------|------|
| **low（低）** | Low | 急がなくて OK |
| **moderate（中）** | Moderate | 時間のあるときに対応 |
| **high（高）** | High | 早めに対応 |
| **critical（緊急）** | Critical | すぐに対応 |

自動修復を試す場合：

```bash
npm audit fix
```

> **`npm audit fix` とは？**
> 見つかった脆弱性のうち、安全に自動修正できるものを修正するコマンドです。すべてが自動修正されるわけではありません。

### トークンが漏洩した場合の対処

万が一、API トークンが外部に漏れてしまった場合：

1. **Sanity**: [https://www.sanity.io/manage](https://www.sanity.io/manage) でトークンを削除し、新しいトークンを発行
2. **GitHub**: Settings → Developer settings → Personal access tokens でトークンを削除し、新しいトークンを発行
3. **Vercel**: Settings → Environment Variables で新しいトークンに更新し、Redeploy
4. `.env.local` のトークンも新しいものに更新

---

## 5. Sanity プロジェクトの管理

### 使用量の確認

Sanity の無料プランには使用量の上限があります。

1. [https://www.sanity.io/manage](https://www.sanity.io/manage) でプロジェクトを開きます
2. **「Usage」** タブで使用量を確認します

### 無料プランの主な上限

| 項目 | 上限 | 個人ブログでの目安 |
|------|------|----------------|
| API リクエスト | 100万回/月 | 十分な余裕あり |
| API CDN リクエスト | 500万回/月 | 十分な余裕あり |
| ドキュメント数 | 1万件 | 個人ブログなら十分（下書きも含まれる点に注意） |
| ストレージ | 10GB | 画像を多用しなければ十分 |
| メンバー数 | 20人 | 個人〜小規模チームは十分 |
| データセット | 2つ（公開のみ） | `production` 1つで十分 |

> **ポイント**: 個人ブログであれば、無料プランの上限に達することはほぼありません。

### 不要なデータの整理

Sanity Studio で不要な下書き記事を定期的に削除すると、管理しやすくなります。

1. `/studio` にアクセスします
2. **「Post」** をクリックします
3. 不要な下書き記事を選択して削除します

---

## 6. サイトのパフォーマンス確認

### PageSpeed Insights で確認

Google が提供する無料のサイト速度チェックツールです。

1. [https://pagespeed.web.dev](https://pagespeed.web.dev) にアクセスします
2. サイトの URL を入力します
3. **「分析」** をクリックします
4. スコアを確認します

| スコア | 評価 | 対応 |
|--------|------|------|
| 90〜100 | 優秀 | 現状維持で OK |
| 50〜89 | 改善の余地あり | 時間のあるときに最適化 |
| 0〜49 | 要改善 | 画像の最適化などを検討 |

> **よくある改善ポイント**:
> - 画像が大きすぎる → 画像の圧縮やサイズ変更
> - 不要なパッケージが多い → 使っていないパッケージの削除
> - これらの改善は AI ツールに依頼すると効率的です

---

## 7. 年次チェックリスト

年に 1 回、以下を確認しておくと安心です。

### アカウント関連

- [ ] Sanity のアカウントにログインできるか
- [ ] GitHub のアカウントにログインできるか
- [ ] Vercel のアカウントにログインできるか
- [ ] 登録しているメールアドレスが現在使えるものか

### ドメイン・証明書関連

- [ ] カスタムドメインを使用している場合、ドメインの更新期限を確認
- [ ] SSL 証明書（`https` のための証明書）は Vercel が自動管理するため確認不要

### 技術的な確認

- [ ] Node.js のバージョンがサポート期間内か（[https://nodejs.org/en/about/previous-releases](https://nodejs.org/en/about/previous-releases) で確認）
- [ ] 使っている主要パッケージ（Next.js、Sanity）が大きなバージョンアップをしていないか

> **ポイント**: 大きなバージョンアップが必要な場合は、AI ツールに「Next.js のメジャーバージョンアップをしたい」のように相談すると、必要な変更を教えてくれます。

---

前のステップ ← [06-troubleshooting.md](./06-troubleshooting.md)
最初に戻る → [00-overview.md](./00-overview.md)
