# トラブルシューティング総合ガイド

サイトの運用中に発生しやすいトラブルと、その対処方法をまとめた総合ガイドです。各セットアップ手順書にも個別のトラブル対処が書かれていますが、ここでは**サービス横断的な視点**で問題の切り分けから解決までを説明します。

---

## 目次

1. [トラブル対応の基本ステップ](#1-トラブル対応の基本ステップ)
2. [サイトが表示されない](#2-サイトが表示されない)
3. [記事が反映されない](#3-記事が反映されない)
4. [Sanity Studio にアクセスできない](#4-sanity-studio-にアクセスできない)
5. [デプロイが失敗する](#5-デプロイが失敗する)
6. [GitHub にプッシュできない](#6-github-にプッシュできない)
7. [開発環境（localhost）が動かない](#7-開発環境localhostが動かない)
8. [エラーメッセージの読み方](#8-エラーメッセージの読み方)
9. [どうしても解決しない場合](#9-どうしても解決しない場合)

---

## 1. トラブル対応の基本ステップ

問題が起きたときは、慌てずに以下の順番で対応しましょう。

```
① 何が起きているかを確認する（症状の把握）
      ↓
② いつから起きているかを思い出す（直前の変更は？）
      ↓
③ エラーメッセージを確認する（英語でも大丈夫、コピーして検索）
      ↓
④ このガイドで該当する項目を探す
      ↓
⑤ 対処法を試す（1 つずつ順番に）
```

> **大事なこと**: 問題が起きても、データが消えることはほとんどありません。記事は Sanity に、コードは GitHub に保存されています。落ち着いて対処しましょう。

---

## 2. サイトが表示されない

### 症状：白い画面が表示される / エラーページが出る

**チェック 1: インターネット接続を確認**
- 他のサイト（Google など）は表示できるか確認してください

**チェック 2: Vercel のステータスを確認**
1. [https://vercel.com/dashboard](https://vercel.com/dashboard) にログインします
2. プロジェクトの最新デプロイが **「Ready」** になっているか確認します
3. **「Error」** の場合 → [5. デプロイが失敗する](#5-デプロイが失敗する) へ

**チェック 3: URL が正しいか確認**
- `https://` から始まっているか
- サイトの URL を間違えていないか

**チェック 4: Vercel のサービス状況を確認**
- [https://www.vercel-status.com](https://www.vercel-status.com) でサービスが正常かどうか確認できます
- 「All Systems Operational（すべてのシステムが稼働中）」と表示されていれば問題ありません

> **それでも解決しない場合**: Vercel ダッシュボードから最新のデプロイの **「⋯」** → **「Redeploy」** で再デプロイを試してください。

---

## 3. 記事が反映されない

### 症状：Sanity で Publish したのにサイトに記事が表示されない

**チェック 1: 60 秒待ってからページを再読み込み**
- このサイトは ISR（段階的静的再生成）を使っているため、反映に最大 60 秒かかります
- ブラウザで `F5`（Mac は `Cmd+R`）を押してページを再読み込みしてください

**チェック 2: Sanity Studio で記事のステータスを確認**
1. `/studio` を開きます
2. 記事をクリックします
3. 画面下部が **「Published」**（緑色）になっているか確認します
4. **「Draft」** のままの場合 → **「Publish」** ボタンを押します

**チェック 3: Slug（スラッグ）が設定されているか確認**
1. Sanity Studio で記事を開きます
2. **Slug** の欄が空欄でないか確認します
3. 空欄の場合 → **「Generate」** ボタンを押してスラッグを生成します

**チェック 4: Published At（公開日）が設定されているか確認**
- 公開日が未設定の場合、記事の並び順がおかしくなることがあります

**チェック 5: 環境変数を確認**
- Vercel の Settings → Environment Variables で、Sanity の接続情報が正しいか確認します
- 特に `NEXT_PUBLIC_SANITY_PROJECT_ID` と `NEXT_PUBLIC_SANITY_DATASET` を確認してください

---

## 4. Sanity Studio にアクセスできない

### 症状：`/studio` にアクセスすると白い画面やエラーが出る

**チェック 1: ログイン状態を確認**
- Sanity のアカウントにログインしているか確認してください
- ブラウザの別タブで [https://www.sanity.io/manage](https://www.sanity.io/manage) にアクセスし、ログインできるか確認してください

**チェック 2: CORS の設定を確認**
1. [https://www.sanity.io/manage](https://www.sanity.io/manage) でプロジェクトを開きます
2. **Settings** → **API** → **CORS origins** を確認します
3. サイトの URL（`https://あなたのサイト.vercel.app`）が登録されているか確認します
4. **Allow credentials** にチェックが入っているか確認します

**チェック 3: ブラウザのキャッシュをクリア**
- `Ctrl+Shift+Delete`（Mac は `Cmd+Shift+Delete`）でブラウザのキャッシュを削除してから再度アクセスしてください

---

## 5. デプロイが失敗する

### 症状：Vercel のダッシュボードで「Error」と表示される

**チェック 1: ビルドログを確認**
1. Vercel ダッシュボードで失敗したデプロイをクリックします
2. **「Building」** のログを確認します
3. 赤い文字のエラーメッセージを探します

### よくあるエラーと対処

| エラーメッセージ | 原因 | 対処法 |
|---------------|------|--------|
| `Module not found: Can't resolve '...'` | 必要なパッケージが不足 | ターミナルで `npm install` を実行してから `git push` |
| `Type error: ...` | コードに型の不整合がある | エラーメッセージに表示されるファイル名と行番号を確認して修正 |
| `Environment variable not found` | 環境変数が未設定 | Vercel の Settings で環境変数を確認・追加 |
| `FATAL ERROR: ... JavaScript heap out of memory` | メモリ不足 | 不要なファイルを削除。大きな画像がないか確認 |
| `Build exceeded maximum duration` | ビルド時間が制限を超えた | 不要なページや大きなファイルを削除 |

**チェック 2: ローカルでビルドを試す**

ターミナルで以下のコマンドを実行して、自分のパソコンでビルドが成功するか確認します。

```bash
npm run build
```

エラーが出たら、そのメッセージを元に修正してください。

**チェック 3: 前回のデプロイに戻す**

修正に時間がかかる場合は、前回の正常なデプロイに戻すことができます。

1. Vercel ダッシュボードの **「Deployments」** タブを開きます
2. 正常に動いていたデプロイ（「Ready」のもの）を探します
3. **「⋯」** メニューから **「Promote to Production」** を選択します

> **「Promote to Production」とは？**
> 過去の正常な状態を現在の公開サイトとして使う操作です。一時的な対処として便利です。

---

## 6. GitHub にプッシュできない

### 症状：`git push` するとエラーが出る

**エラー：`rejected` / `non-fast-forward`**

GitHub 上のコードがローカル（自分のパソコン）より新しい場合に起きます。

```bash
git pull
```

このコマンドで GitHub から最新のコードを取得してから、再度プッシュしてください。

**エラー：`Authentication failed`**

ログイン情報が正しくないか、トークンの有効期限が切れています。

1. GitHub の Personal Access Token を再発行します（[02-article-and-github.md](./02-article-and-github.md) の「コードを GitHub にプッシュする」を参照）
2. 新しいトークンをパスワードの代わりに使用します

**エラー：`Permission denied`**

リポジトリへのアクセス権がありません。

- リポジトリの URL が正しいか確認してください
- リポジトリの所有者に Collaborator として追加してもらってください

---

## 7. 開発環境（localhost）が動かない

### 症状：`npm run dev` するとエラーが出る / localhost:3000 が表示されない

**チェック 1: ポートが使用中でないか確認**

「Port 3000 is already in use」と表示される場合、すでに別のプロセスが 3000 番ポートを使っています。

```bash
# Mac の場合
lsof -i :3000
```

表示されたプロセスを終了するか、開発サーバーを別のポートで起動します。

```bash
npm run dev -- -p 3001
```

> **ポートとは？**
> パソコン上で動いているプログラムが通信するための「窓口番号」です。3000 番の窓口が他のプログラムに使われていると、ブログの開発サーバーが同じ窓口を使えません。

**チェック 2: node_modules を再インストール**

パッケージが壊れている可能性があります。以下のコマンドでパッケージを最初からインストールし直します。

```bash
rm -rf node_modules
npm install
```

> **このコマンドは何をしている？**
> 1 行目の `rm -rf node_modules` は、パッケージが入っているフォルダを丸ごと削除します。2 行目の `npm install` で最初からインストールし直します。
>
> **注意**: `rm -rf` は指定したフォルダを確認なしに完全削除するコマンドです。**必ず `node_modules` と正確に入力してください。** 他のフォルダ名を間違えて指定すると、大切なファイルが消えてしまいます。心配な場合は Cursor の AI に「node_modules を再インストールして」と指示してください。

**チェック 3: .env.local が正しいか確認**

環境変数ファイルの内容を確認してください（[01-local-setup.md](./01-local-setup.md) の「.env.local に設定値を記入」を参照）。

---

## 8. エラーメッセージの読み方

英語のエラーメッセージが出ても怖がらなくて大丈夫です。以下のコツで対処できます。

### よく出てくる英単語

| 英単語 | 意味 | 対処のヒント |
|--------|------|------------|
| `Error` | エラー（問題が起きた） | その後に続くメッセージが原因 |
| `Warning` | 警告（動作するが注意が必要） | すぐには問題ないが確認推奨 |
| `Not found` | 見つからない | ファイル名や URL が間違っている可能性 |
| `Permission denied` | アクセス権がない | ログイン情報やトークンを確認 |
| `Timeout` | 時間切れ | ネット接続を確認。しばらく待って再試行 |
| `Invalid` | 不正な値 | 入力した値（URL、トークンなど）を確認 |
| `Unauthorized` | 認証されていない | トークンやパスワードが正しくない |
| `Deprecated` | 非推奨（古い機能） | すぐには問題ないが将来的に対応が必要 |

### エラーメッセージの調べ方

1. エラーメッセージをそのまま**コピー**します
2. Google で検索します（日本語サイトだけでなく英語サイトも参考になります）
3. **Stack Overflow**（スタックオーバーフロー）というサイトに解決策が載っていることが多いです

> **ポイント**: エラーメッセージの中の、あなた固有の情報（ファイルパスやプロジェクト名など）は削除して検索すると、より適切な結果が見つかりやすくなります。

---

## 9. どうしても解決しない場合

### AI に相談する

Cursor や Claude Code に、エラーメッセージをそのまま貼り付けて相談できます。

```
例: 「以下のエラーが出ています。原因と対処法を教えてください：
     [エラーメッセージをここに貼り付け]」
```

### 各サービスのステータスページ

サービス自体に障害が起きている可能性もあります。

| サービス | ステータスページ |
|---------|---------------|
| Vercel | [https://www.vercel-status.com](https://www.vercel-status.com) |
| Sanity | [https://status.sanity.io](https://status.sanity.io) |
| GitHub | [https://www.githubstatus.com](https://www.githubstatus.com) |

> **ステータスページとは？**
> サービスが正常に動作しているかどうかを公開しているページです。障害が発生している場合は、サービス提供元が対応するのを待つしかありません。通常は数時間以内に復旧します。

### 最終手段：過去の正常な状態に戻す

- **コードの問題**: GitHub で過去のコミットに戻すことができます
- **デプロイの問題**: Vercel で過去のデプロイを再公開できます（[5. デプロイが失敗する](#5-デプロイが失敗する) を参照）
- **記事の問題**: Sanity Studio で記事を編集し直すか、`blog/` フォルダのバックアップから復元できます

---

前のステップ ← [05-daily-operations.md](./05-daily-operations.md)
次のステップ → [07-site-maintenance.md](./07-site-maintenance.md) に進みましょう
