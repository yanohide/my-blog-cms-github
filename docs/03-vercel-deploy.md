# Step 3: ブログサイトを Web で公開する

このステップでは、ブログサイトをインターネットに公開します。**ゴールはサイトが公開され、Sanity で投稿した記事が自動的にサイトに表示されることを確認すること**です。

> **デプロイとは？** プログラムをサーバー（インターネット上のコンピューター）に配置して、誰でもアクセスできる状態にすることです。「公開」と同じ意味です。

---

## 目次

1. [ブログの仕組みを理解する](#1-ブログの仕組みを理解する)
2. [Vercel のアカウント登録（GitHub 連携）](#2-vercel-のアカウント登録github-連携)
3. [プロジェクトのインポート](#3-プロジェクトのインポート)
4. [環境変数の設定](#4-環境変数の設定)
5. [デプロイの確認](#5-デプロイの確認)
6. [Sanity の CORS に Vercel URL を追加](#6-sanity-の-cors-に-vercel-url-を追加)
7. [記事が自動反映されることを確認する](#7-記事が自動反映されることを確認する)
8. [ここまでの確認](#8-ここまでの確認)
9. [カスタムドメインの設定（任意）](#9-カスタムドメインの設定任意)
10. [デプロイ失敗時のチェックリスト](#10-デプロイ失敗時のチェックリスト)

---

## 1. ブログの仕組みを理解する

ここで、ブログサイトの全体像を理解しておきましょう。**記事の更新**と**サイト（UI）の更新**は別々の仕組みで動きます。

```
┌──── 記事の流れ ────────────────────────────────────┐
│                                                    │
│  Sanity に記事を投稿 → サイトが自動的に読み込み      │
│                        (最大 60 秒で反映)            │
│                                                    │
│  ※ GitHub や Vercel の操作は不要                    │
└────────────────────────────────────────────────────┘

┌──── UI・コードの流れ ──────────────────────────────┐
│                                                    │
│  コードを変更 → GitHub にプッシュ → Vercel が自動ビルド │
│                                     (1〜3 分で反映)   │
│                                                    │
│  ※ デザインやレイアウトを変えたときだけ              │
└────────────────────────────────────────────────────┘
```

| 何を変えたか | どうすれば反映される | 所要時間 |
|------------|-------------------|---------|
| **記事の投稿・編集** | Sanity で Publish するだけ | 最大 60 秒 |
| **デザイン・レイアウト変更** | コードを修正して `git push` | 1〜3 分 |

> **なぜ記事の反映に GitHub は不要？** サイトは Sanity の API からリアルタイムに記事データを読み込んでいます（ISR: Incremental Static Regeneration）。記事の追加・編集は Sanity だけで完結し、Vercel の再デプロイは必要ありません。

---

## 2. Vercel のアカウント登録（GitHub 連携）

1. ブラウザで [https://vercel.com](https://vercel.com) を開きます
2. **「Sign Up」** をクリックします
3. **「Continue with GitHub」** を選択します
4. GitHub のアカウント情報でログインします
5. Vercel に GitHub へのアクセスを許可します（**「Authorize Vercel」** をクリック）

> **なぜ GitHub 連携？** サイトのデザインやコードを変更したとき、GitHub にプッシュするだけで Vercel が自動的にサイトを更新してくれます。

---

## 3. プロジェクトのインポート

GitHub のリポジトリを Vercel に取り込みます。

1. Vercel のダッシュボードで **「Add New...」** → **「Project」** をクリックします
2. GitHub のリポジトリ一覧からブログのリポジトリの **「Import」** をクリックします
3. **Configure Project** 画面で以下を確認します：
   - **Framework Preset**: **「Next.js」** が自動選択されていること（変更不要）
   - **Root Directory**: 空欄のまま（変更不要）
4. 環境変数を設定してから（次のセクション参照）、**「Deploy」** をクリックします

> **リポジトリが表示されない場合**: 「Adjust GitHub App Permissions」をクリックして、対象リポジトリへのアクセスを許可してください。

---

## 4. 環境変数の設定

`.env.local` に書いた内容と同じものを Vercel にも登録します。

### 設定する環境変数（3 つ）

| Name | Value | 説明 |
|------|-------|------|
| `NEXT_PUBLIC_SANITY_PROJECT_ID` | あなたの Project ID | Sanity のプロジェクト識別子 |
| `NEXT_PUBLIC_SANITY_DATASET` | `production` | データセット名 |
| `SANITY_API_TOKEN` | あなたの API トークン | Sanity のデータを読み書きするための合言葉 |

### 設定手順

Configure Project 画面の **「Environment Variables」** セクションを開き、上の 3 つを 1 つずつ **Name** と **Value** に入力して **「Add」** をクリックします。3 つ追加したら **「Deploy」** をクリックします。

> **この環境変数は何のため？** Vercel 上のサイトが Sanity から記事を読み込むための接続情報です。ローカル（`.env.local`）と Vercel の両方に同じ値を設定する必要があります。

---

## 5. デプロイの確認

1. デプロイが完了すると **「Congratulations!」** の画面が表示されます
2. サイトの URL が表示されます（例：`https://my-blog-xxxxx.vercel.app`）
3. URL をクリックして以下を確認します：
   - トップページが表示される
   - Step 2 で投稿した記事が一覧に表示される
   - `/studio` で Sanity Studio が表示される

---

## 6. Sanity の CORS に Vercel URL を追加

サイトの URL がわかったので、Sanity のセキュリティ設定を更新します。

1. [https://www.sanity.io/manage](https://www.sanity.io/manage) でプロジェクトを開きます
2. **Settings** → **API** → **CORS origins**
3. **「Add CORS origin」** で以下を追加します：

| Origin | Allow credentials |
|--------|------------------|
| `https://あなたのサイト.vercel.app` | ✅ チェックする |

---

## 7. 記事が自動反映されることを確認する

ここが Step 3 のハイライトです。**Sanity で記事を投稿するだけで、公開サイトに記事が表示されること**を確認しましょう。

### やってみよう

1. ブラウザで公開サイト（`https://あなたのサイト.vercel.app/studio`）の Sanity Studio を開きます
2. 新しい記事を作成して **「Publish」** します（内容は Step 2 のサンプル記事と同じで OK）
3. **60 秒待ってから**、公開サイトのトップページ（`https://あなたのサイト.vercel.app`）を再読み込みします
4. 新しい記事が表示されていれば成功です！

### 記事が反映される仕組み

```
Sanity Studio で記事を Publish
        ↓
Sanity のデータベースに保存
        ↓ (最大 60 秒)
Vercel 上のサイトが Sanity API から最新データを取得（ISR）
        ↓
公開サイトに記事が表示される
```

> **ISR（Incremental Static Regeneration）とは？** サイトにアクセスがあったとき、前回の表示から 60 秒以上経っていれば、裏側で最新データを取得してページを再生成する仕組みです。`git push` や再デプロイは不要です。

### 補足：UI やデザインを変更した場合

記事ではなく**サイトのデザインやレイアウト**を変更した場合は、`git push` が必要です。

```bash
# 例：レイアウトの文言やデザインを変更したとき
git add .
git commit -m "ヘッダーのデザインを変更"
git push
```

Vercel ダッシュボード（[https://vercel.com/dashboard](https://vercel.com/dashboard)）の **「Deployments」** タブを見ると、新しいデプロイが自動で始まり、1〜3 分で公開サイトに反映されます。

> **ビルドとは？** コードをブラウザで表示できる形に変換する処理です。料理にたとえると「材料（コード）を調理して完成品（サイト）にする」工程です。

---

## 8. ここまでの確認

以下がすべてクリアできていれば、Step 3 完了です！

- [ ] `https://あなたのサイト.vercel.app` でブログサイトが表示される
- [ ] Step 2 で作成した記事がサイトに表示されている
- [ ] Sanity Studio で記事を Publish したら、60 秒以内にサイトに反映された
- [ ] Sanity の CORS に Vercel の URL を追加した

🎉 **おめでとうございます！ブログサイトがインターネットに公開されました。** あとは記事を書いて投稿するだけです。Step 4 で日常の運用フローを学びましょう。

---

## 9. カスタムドメインの設定（任意）

デフォルトでは `xxxx.vercel.app` という URL ですが、独自のドメイン（例：`myblog.com`）を設定することもできます。

1. ドメインを取得します（お名前.com、Cloudflare Registrar などで購入）
2. Vercel ダッシュボード → **「Settings」** → **「Domains」**
3. ドメイン名を入力して **「Add」**
4. 表示される DNS 設定をドメイン管理サービスに登録します

> この手順は任意です。`xxxx.vercel.app` のままでもサイトは問題なく使えます。

---

## 10. デプロイ失敗時のチェックリスト

### ビルドエラーの確認方法

Vercel ダッシュボード → 失敗したデプロイをクリック → ログの赤い文字のエラーメッセージを確認します。

### よくある原因と対処

| エラー | 原因 | 対処 |
|--------|------|------|
| `Module not found` | パッケージ不足 | `npm install` してから再度 push |
| `Environment variable not found` | 環境変数が未設定 | Vercel Settings で環境変数を確認 |
| `Type error` | コードの文法エラー | エラー箇所を修正 |

### パソコンでの事前チェック

```bash
npm run build
```

> Vercel と同じビルド処理をパソコンで試せます。エラーが出なければ Vercel でも問題なく動くはずです。

---

前のステップ ← [Step 2: サンプル記事を作って GitHub と連携する](./02-article-and-github.md)
次のステップ → [Step 4: 日常の記事運用をはじめる](./04-daily-workflow.md)
